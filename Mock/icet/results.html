<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICET Mock Test - Results</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .score-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .score-item {
            text-align: center;
        }
        
        .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .score-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .results-summary {
            margin-bottom: 30px;
        }
        
        .question-result {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        .question-result.correct {
            border-left: 5px solid #2ecc71;
        }
        
        .question-result.incorrect {
            border-left: 5px solid #e74c3c;
        }
        
        .question-result.unanswered {
            border-left: 5px solid #f39c12;
        }
        
        .question-text {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .question-image {
            max-width: 100%;
            max-height: 300px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .options {
            margin: 15px 0;
        }
        
        .option {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .correct-answer {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .user-answer.correct {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .user-answer.incorrect {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .explanation {
            margin-top: 10px;
            padding: 10px;
            background-color: #e2e3e5;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .performance-chart {
            width: 100%;
            max-width: 500px;
            margin: 30px auto;
        }
    </style>
    <!-- Chart.js for performance visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ICET Mock Test Results</h1>
            <p>Year: <strong id="examYear"></strong></p>
        </div>
        
        <div class="score-card">
            <div class="score-item">
                <div class="score-value" id="scoreValue">0</div>
                <div class="score-label">Score</div>
            </div>
            <div class="score-item">
                <div class="score-value" id="totalQuestions">0</div>
                <div class="score-label">Total Questions</div>
            </div>
            <div class="score-item">
                <div class="score-value" id="correctAnswers">0</div>
                <div class="score-label">Correct Answers</div>
            </div>
            <div class="score-item">
                <div class="score-value" id="incorrectAnswers">0</div>
                <div class="score-label">Incorrect Answers</div>
            </div>
            <div class="score-item">
                <div class="score-value" id="timeTaken">0</div>
                <div class="score-label">Time Taken (minutes)</div>
            </div>
        </div>
        
        <div class="performance-chart">
            <canvas id="performanceChart"></canvas>
        </div>
        
        <div class="results-summary">
            <h2>Detailed Results</h2>
            <div id="questionsResults">
                <!-- Questions with answers will be loaded here -->
            </div>
        </div>
        
        <div class="action-buttons">
            <a href="index.html" class="btn btn-primary">Take Another Test</a>
            <a href="#" id="downloadBtn" class="btn btn-secondary">Download Results</a>
        </div>
    </div>
    
   <script>
    // Make scriptUrl accessible
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbyjh8oxAQyWxsjPtKblUqr8Q5pLpI69iZRRZv3clTKVKzeyQXHxLPZ_MzpENWXDFaW-/exec'; // Replace with your deployed web app URL
    let examQuestions = [];

    document.addEventListener('DOMContentLoaded', async () => {
        const results = JSON.parse(localStorage.getItem('examResults'));
        if (!results) {
            window.location.href = 'index.html';
            return;
        }

        // Load the original exam questions
        try {
            const response = await fetch(`${scriptUrl}?operation=getExam&year=${results.year}`);
            const data = await response.json();
            
            if (data.status === 'success') {
                examQuestions = data.questions;
                displayResults(results);
                renderPerformanceChart(results);
            } else {
                throw new Error(data.message || 'Failed to load exam questions');
            }
        } catch (error) {
            console.error('Error loading questions:', error);
            document.getElementById('questionsResults').innerHTML = 
                `<p style="color:red">Error loading questions: ${error.message}</p>`;
        }

        // Download button functionality
        document.getElementById('downloadBtn').addEventListener('click', () => {
            downloadResults(results);
        });
    });

    function displayResults(results) {
        document.getElementById('examYear').textContent = results.year;
        document.getElementById('scoreValue').textContent = `${results.score}/${results.totalQuestions}`;
        document.getElementById('totalQuestions').textContent = results.totalQuestions;
        document.getElementById('correctAnswers').textContent = results.score;
        document.getElementById('incorrectAnswers').textContent = 
            Object.values(results.answers).length - results.score;
        document.getElementById('timeTaken').textContent = results.timeTaken.toFixed(1);

        const questionsContainer = document.getElementById('questionsResults');
        questionsContainer.innerHTML = '';

        examQuestions.forEach((question, index) => {
            const userAnswer = results.answers[index];
            const isCorrect = userAnswer === question.correctAnswer;
            const isAnswered = userAnswer !== undefined;
    
            const questionDiv = document.createElement('div');
            questionDiv.className = `question-result ${isCorrect ? 'correct' : 
                (isAnswered ? 'incorrect' : 'unanswered')}`;
            
            let questionHTML = `
                <div class="question-text">Question ${index + 1}: ${question.question}</div>
            `;
            
            if (question.imageUrl) {
                questionHTML += `<img src="${question.imageUrl}" class="question-image" alt="Question image">`;
            }
            
            questionHTML += '<div class="options">';
            for (const [key, value] of Object.entries(question.options)) {
                let optionClass = '';
                if (key === question.correctAnswer) {
                    optionClass = 'correct-answer';
                } else if (key === userAnswer) {
                    optionClass = isCorrect ? 'correct' : 'incorrect';
                }
                
                questionHTML += `
                    <div class="option ${optionClass}">
                        <strong>${key}.</strong> ${value}
                        ${key === question.correctAnswer ? ' (Correct)' : ''}
                        ${key === userAnswer ? ' (Your answer)' : ''}
                    </div>
                `;
            }
            questionHTML += '</div>';
        
            questionHTML += `
                <div class="explanation">
                    <strong>Correct Answer:</strong> ${question.correctAnswer}
                </div>
            `;
            
            questionDiv.innerHTML = questionHTML;
            questionsContainer.appendChild(questionDiv);
        });
    }

    function renderPerformanceChart(results) {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        const correct = results.score;
        const incorrect = Object.values(results.answers).length - results.score;
        const unanswered = results.totalQuestions - (correct + incorrect);
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Correct', 'Incorrect', 'Unanswered'],
                datasets: [{
                    data: [correct, incorrect, unanswered],
                    backgroundColor: [
                        '#2ecc71',
                        '#e74c3c',
                        '#f39c12'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: 'Performance Summary',
                        font: {
                            size: 16
                        }
                    }
                }
            }
        });
    }

    function downloadResults(results) {
        try {
            // Create a text version of the results
            let resultText = `ICET Mock Test Results - Year ${results.year}\n`;
            resultText += `========================================\n\n`;
            resultText += `Score: ${results.score}/${results.totalQuestions}\n`;
            resultText += `Correct Answers: ${results.score}\n`;
            resultText += `Incorrect Answers: ${Object.values(results.answers).length - results.score}\n`;
            resultText += `Unanswered Questions: ${results.totalQuestions - Object.values(results.answers).length}\n`;
            resultText += `Time Taken: ${results.timeTaken.toFixed(1)} minutes\n\n`;
            resultText += `Detailed Answers:\n\n`;
            
            // Add each question with answers
            examQuestions.forEach((question, index) => {
                const userAnswer = results.answers[index];
                const isCorrect = userAnswer === question.correctAnswer;
                
                resultText += `Question ${index + 1}: ${question.question}\n`;
                
                // Add options
                for (const [key, value] of Object.entries(question.options)) {
                    let prefix = '   ';
                    if (key === question.correctAnswer) prefix = '✓ ';
                    if (key === userAnswer) prefix = isCorrect ? '✓ ' : '✗ ';
                    
                    resultText += `${prefix}${key}. ${value}\n`;
                }
                
                resultText += `\nCorrect Answer: ${question.correctAnswer}\n`;
                resultText += `Your Answer: ${userAnswer || 'Not attempted'}\n`;
                resultText += `Status: ${isCorrect ? 'CORRECT' : (userAnswer ? 'INCORRECT' : 'NOT ATTEMPTED')}\n\n`;
                resultText += `----------------------------------------\n\n`;
            });
            
            // Create download link
            const blob = new Blob([resultText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ICET_Results_${results.year}.txt`;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        } catch (error) {
            console.error('Download failed:', error);
            alert('Failed to download results. Please try again.');
        }
    }
</script>
</body>
</html>
